{% extends "base.html" %}
{% load static %}
{% load base_tags %}

{% block content %}
<div class="content">
  <div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="h4 mb-0">{{ title|default:"รายการ" }}</h2>
      {% if create_url_name %}
        <a href="{% url create_url_name %}" class="btn btn-success">
          <i class="bi bi-plus-lg me-1"></i> เพิ่มใหม่
        </a>
      {% else %}
        <a href="#" class="btn btn-success disabled" aria-disabled="true">
          <i class="bi bi-plus-lg me-1"></i> เพิ่มใหม่
        </a>
      {% endif %}
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <form method="get" class="row gy-2 gx-3">
          <div class="col-md-4 col-lg-3">
            <label class="form-label mb-1" for="search">ค้นหา</label>
            <input id="search" name="q" type="text" class="form-control" placeholder="ค้นหา..." value="{{ request.GET.q }}">
          </div>
          <div class="col-md-3 col-lg-2">
            <label class="form-label mb-1" for="start_date">ตั้งแต่วันที่</label>
            <input id="start_date" name="start_date" type="date" class="form-control" value="{{ start_date }}">
          </div>
          <div class="col-md-3 col-lg-2">
            <label class="form-label mb-1" for="end_date">ถึงวันที่</label>
            <input id="end_date" name="end_date" type="date" class="form-control" value="{{ end_date }}">
          </div>
          <div class="col-12 mt-2">
            <div class="btn-group">
              <button class="btn btn-primary" type="submit"><i class="bi bi-search me-1"></i> ค้นหา</button>
              <a href="{{ request.path }}" class="btn btn-secondary"><i class="bi bi-x-lg me-1"></i> ล้างค่า</a>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-light text-center">
              <tr>
                {% for field in list_display %}
                  <th class="{% if forloop.first %}text-start{% else %}text-end{% endif %}">{{ field_labels|dict_get:field }}</th>
                {% endfor %}
                <th style="width:150px;">การจัดการ</th>
              </tr>
            </thead>
            <tbody>
              {% for obj in object_list %}
              <tr>
                {% for field in list_display %}
                  <td class="{% if forloop.first %}text-start{% else %}text-end{% endif %}">{{ obj|get_value:field }}</td>
                {% endfor %}
                <td class="text-center">
                  <a href="{% url detail_url_name obj.pk %}" class="btn btn-sm btn-outline-info me-1"><i class="bi bi-eye"></i></a>
                  <a href="{% url update_url_name obj.pk %}" class="btn btn-sm btn-outline-primary me-1"><i class="bi bi-pencil-square"></i></a>
                  <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-url="{% url delete_url_name obj.pk %}" data-name="{{ obj }}"><i class="bi bi-trash"></i></button>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="{{ list_display|length|add:'1' }}" class="text-center text-muted py-4"><i class="bi bi-inbox"></i> ไม่พบข้อมูล</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {% if is_paginated %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page=1{{ request.GET.urlencode|cut:'page=' }}" aria-label="First">&laquo;&laquo;</a></li>
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{{ request.GET.urlencode|cut:'page=' }}" aria-label="Previous">&laquo;</a></li>
        {% endif %}
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}{{ request.GET.urlencode|cut:'page=' }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{{ request.GET.urlencode|cut:'page=' }}" aria-label="Next">&raquo;</a></li>
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{{ request.GET.urlencode|cut:'page=' }}" aria-label="Last">&raquo;&raquo;</a></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form method="post" id="deleteForm">
          {% csrf_token %}
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title" id="confirmDeleteModalLabel"><i class="bi bi-exclamation-triangle me-1"></i> Confirm delete</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Delete <strong id="deleteObjectName">this item</strong>?</p>
              <p class="text-danger mb-0"><i class="bi bi-info-circle me-1"></i> This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">Delete</button>
            </div>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<style>
  .table td, .table th { white-space: nowrap; padding-top: 0.45rem; padding-bottom: 0.45rem; }
</style>
{% endblock %}

{% block extra_js %}
<script>
  const modal = document.getElementById('confirmDeleteModal');
  modal.addEventListener('show.bs.modal', function (event) {
    const btn = event.relatedTarget;
    document.getElementById('deleteForm').action = btn.dataset.url;
    document.getElementById('deleteObjectName').textContent = btn.dataset.name;
  });
</script>
{% endblock %}
