{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load form_extras %}

{% block content %}
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <!-- ===== ฟอร์มหลักแบบ fieldsets ===== -->
  {% if form %}
    {% for section_title, opts in fieldsets %}
    <div class="card mb-4">
      {% if section_title %}
      <div class="card-header">
        <h5 class="mb-0">{{ section_title }}</h5>
      </div>
      {% endif %}
      <div class="card-body">
        {% for row in opts.fields %}
          {% if row.0 %}
            <div class="row">
              {% for field in row %}
                {% if field in form.fields %}
                  {% with field_obj=form|get_field:field %}
                    <div class="col-md-6">{{ field_obj|as_crispy_field }}</div>
                  {% endwith %}
                {% else %}
                  <div class="col-md-6 text-danger">
                    <strong>Field "{{ field }}" ไม่พบในฟอร์ม</strong>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% else %}
            {% if row in form.fields %}
              {% with field_obj=form|get_field:row %}
                {{ field_obj|as_crispy_field }}
              {% endwith %}
            {% else %}
              <div class="text-danger">
                <strong>Field "{{ row }}" ไม่พบในฟอร์ม</strong>
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  {% endif %}
  <!-- ===== Formset Sections (หลายชุด) ===== -->
  {% for section in formset_sections %}
  <div class="card mb-4 border">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0">{{ section.title }}</h6>
      {% if section.htmx_url %}
      <button type="button" class="btn btn-sm btn-primary"
              hx-get="{{ section.htmx_url }}"
              hx-vals='js:{"add-form": 1, "form_count": document.querySelector("#id_{{ section.prefix }}-TOTAL_FORMS").value}'
              hx-target="#formset-container-{{ section.prefix }}"
              hx-swap="beforeend"
              hx-on::after-request="
                const total = document.querySelector('#id_{{ section.prefix }}-TOTAL_FORMS');
                total.value = +total.value + 1;">
        + เพิ่ม
      </button>
      {% endif %}
    </div>

    <div class="card-body p-0">
      {% include section.partial with formset=section.formset prefix=section.prefix columns=section.columns only %}
    </div>
  </div>
  {% endfor %}

  <!-- ===== ปุ่มบันทึก ===== -->
  <div class="d-flex justify-content-end">
    <button type="submit" class="btn btn-success px-5">
      <i class="bi bi-save me-2"></i> บันทึก
    </button>
  </div>
</form>
{% endblock %}
